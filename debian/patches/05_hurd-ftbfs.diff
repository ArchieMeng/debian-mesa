From: Samuel Thibault <samuel.thibault@ens-lyon.org>
Subject: Fix build on GNU/Hurd

---
 configure.ac       |   25 ++++++++++++++-----------
 src/glx/x11/dri2.c |    2 ++
 2 files changed, 16 insertions(+), 11 deletions(-)

Index: mesa-7.6.1~rc2/src/glx/x11/dri2.c
===================================================================
--- mesa-7.6.1~rc2.orig/src/glx/x11/dri2.c	2009-12-05 23:51:01.000000000 +0100
+++ mesa-7.6.1~rc2/src/glx/x11/dri2.c	2009-12-06 00:10:10.000000000 +0100
@@ -30,6 +30,7 @@
  *   Kristian HÃ¸gsberg (krh@redhat.com)
  */
 
+#ifdef GLX_DIRECT_RENDERING
 
 #define NEED_REPLIES
 #include <X11/Xlibint.h>
@@ -377,3 +378,4 @@
    UnlockDisplay(dpy);
    SyncHandle();
 }
+#endif
Index: mesa-7.6.1~rc2/configure.ac
===================================================================
--- mesa-7.6.1~rc2.orig/configure.ac	2009-12-05 23:50:57.000000000 +0100
+++ mesa-7.6.1~rc2/configure.ac	2009-12-06 00:10:27.000000000 +0100
@@ -538,6 +538,13 @@
     enable_xcb=no
 fi
 
+dnl Direct rendering or just indirect rendering
+AC_ARG_ENABLE([driglx-direct],
+    [AS_HELP_STRING([--disable-driglx-direct],
+        [enable direct rendering in GLX for DRI @<:@default=enabled@:>@])],
+    [driglx_direct="$enableval"],
+    [driglx_direct="yes"])
+
 dnl
 dnl libGL configuration per driver
 dnl
@@ -571,11 +578,13 @@
         AC_MSG_ERROR([Can't use static libraries for DRI drivers])
     fi
 
-    # Check for libdrm
-    PKG_CHECK_MODULES([LIBDRM], [libdrm >= $LIBDRM_REQUIRED])
-    PKG_CHECK_MODULES([DRI2PROTO], [dri2proto >= $DRI2PROTO_REQUIRED])
-    GL_PC_REQ_PRIV="libdrm >= $LIBDRM_REQUIRED dri2proto >= $DRI2PROTO_REQUIRED"
-    DRI_PC_REQ_PRIV="libdrm >= $LIBDRM_REQUIRED"
+    if test x"$driglx_direct" = xyes; then
+        # Check for libdrm
+        PKG_CHECK_MODULES([LIBDRM], [libdrm >= $LIBDRM_REQUIRED])
+        PKG_CHECK_MODULES([DRI2PROTO], [dri2proto >= $DRI2PROTO_REQUIRED])
+        GL_PC_REQ_PRIV="libdrm >= $LIBDRM_REQUIRED dri2proto >= $DRI2PROTO_REQUIRED"
+        DRI_PC_REQ_PRIV="libdrm >= $LIBDRM_REQUIRED"
+    fi
 
     PKG_CHECK_MODULES([LIBDRM_RADEON], [libdrm_radeon], HAVE_LIBDRM_RADEON=yes, HAVE_LIBDRM_RADEON=no)
 
@@ -656,12 +665,6 @@
     [DRI_DRIVER_SEARCH_DIR="$withval"],
     [DRI_DRIVER_SEARCH_DIR='${DRI_DRIVER_INSTALL_DIR}'])
 AC_SUBST([DRI_DRIVER_SEARCH_DIR])
-dnl Direct rendering or just indirect rendering
-AC_ARG_ENABLE([driglx-direct],
-    [AS_HELP_STRING([--disable-driglx-direct],
-        [enable direct rendering in GLX for DRI @<:@default=enabled@:>@])],
-    [driglx_direct="$enableval"],
-    [driglx_direct="yes"])
 dnl Which drivers to build - default is chosen by platform
 AC_ARG_WITH([dri-drivers],
     [AS_HELP_STRING([--with-dri-drivers@<:@=DIRS...@:>@],
