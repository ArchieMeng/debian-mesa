From: Anssi Hannula &lt;anssi.hannula@iki.fi&gt;
Date: Sun, 5 Aug 2012 00:47:06 +0300
Subject: [PATCH] Fix undefined symbols in libOSMesa and libglapi

---
 src/mapi/shared-glapi/Makefile.am   |    2 +-
 src/mesa/Makefile.am                |    2 +-
 src/mesa/drivers/osmesa/Makefile.am |    6 ++++++
 3 files changed, 8 insertions(+), 2 deletions(-)

--- a/src/mapi/shared-glapi/Makefile.am
+++ b/src/mapi/shared-glapi/Makefile.am
@@ -6,7 +6,7 @@
 
 lib_LTLIBRARIES = libglapi.la
 libglapi_la_SOURCES = $(MAPI_GLAPI_FILES)
-libglapi_la_LDFLAGS = -no-undefined
+libglapi_la_LDFLAGS = -no-undefined -pthread
 
 include $(GLAPI)/gen/glapi_gen.mk
 glapi_mapi_tmp.h : $(GLAPI)/gen/gl_and_es_API.xml $(glapi_gen_mapi_deps)
--- a/src/mesa/Makefile.am
+++ b/src/mesa/Makefile.am
@@ -124,7 +124,7 @@
 	$(MESA_CXX_FILES) \
         $(MESA_ASM_FILES_FOR_ARCH)
 
-libmesa_la_LIBADD = $(top_builddir)/src/glsl/libglsl.la
+libmesa_la_LIBADD = $(top_builddir)/src/glsl/libglsl.la -ldl
 libmesa_la_LDFLAGS =
 
 libmesagallium_la_SOURCES = \
--- a/src/mesa/drivers/osmesa/Makefile.am
+++ b/src/mesa/drivers/osmesa/Makefile.am
@@ -40,6 +40,12 @@
 lib@OSMESA_LIB@_la_LIBADD = \
 	$(top_builddir)/src/mesa/libmesa.la \
 	$(top_builddir)/src/mapi/glapi/libglapi.la
+lib@OSMESA_LIB@_la_LIBTOOLFLAGS = --tag=CXX
+
+if HAVE_SHARED_GLAPI
+lib@OSMESA_LIB@_la_LDFLAGS += -L$(top_builddir)/$(LIB_DIR)
+lib@OSMESA_LIB@_la_LIBADD += -lglapi
+endif
 
 if BUILD_SHARED
 # Provide compatibility with scripts for the old Mesa build system for
